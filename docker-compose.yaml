services:
  #Lucee server
  lucee:
    image: lucee
    ports:
      - "8891:8888"
      - "8091:8088"
    links:
       - mysql
    environment:
      LUCEE_JAVA_OPTS: "-javaagent:/opt/fusionreactor/instance/lucee/fusionreactor.jar=name=Lucee,address=8088 -agentpath:/opt/fusionreactor/instance/lucee/libfrjvmti_x64.so -Dfrlicense=xxxxxxxxxxxx"
      acceptEULA: "YES"
      password: "a"
      FRNAME: "Lucee"

    volumes:
      - "./lucee/apps:/var/www/"

  #mysql database
  mysql:
    image: mysqldb1
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: my-secret-pw
      MYSQL_ROOT_HOST: "%"

  #jmeter
  jmeter:
    image: jmeter
    deploy:
      replicas: 1
    volumes:
      - type: bind
        source: ./jmeter/cfload.jmx
        target: /load.jmx

  #OTEL Go app
  go-app:
    image: go-app
    ports:
    - 3000:3000
    environment:
      - OTEL_EXPORTER_OTLP_TRACES_ENDPOINT=http://fr-observability:4318/v1/traces
      - OTEL_EXPORTER_OTLP_METRICS_ENDPOINT=http://fr-observability:4318/v1/metrics
      - OTEL_SERVICE_NAME=appOTEL
      - OTEL_RESOURCE_ATTRIBUTES="application=appOTEL"

  #observability agent
  fr-observability:
    image: intergral/observability-agent:latest
    ports:
      - 12345:12345
    environment:
      - api_key=xxxxxxxxxxxxxxxxxxx
      - mysql_connection_string=root:my-secret-pw@(mysql:3306)/
      - otel_collection=true

  #spring java app
  storefront:
    image: storefront
    stdin_open: true
    tty: true
    links:
       - mysql
    ports:
      - "8092:8088"
      - "8080:8080"
      - "8182:8888"
    volumes:
      - "./logs:/opt/fusionreactor/instance/steamstorefront/log"
      - "./archive:/opt/fusionreactor/instance/steamstorefront/archive"
